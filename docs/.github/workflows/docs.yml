name: ðŸ“š Deploy Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'backend/**/*.js'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'backend/**/*.js'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'
  DOCS_DIR: 'docs'

jobs:
  # ============================================================================
  # VALIDAÃ‡ÃƒO E TESTES
  # ============================================================================
  validate:
    name: ðŸ” Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.DOCS_DIR }}/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          npm ci
          npm install -g swagger-codegen-cli
      
      - name: ðŸ” Validate OpenAPI specification
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          if [ -f "api/openapi.yaml" ]; then
            swagger-codegen validate -i api/openapi.yaml
            echo "âœ… OpenAPI specification is valid"
          else
            echo "âš ï¸ OpenAPI specification not found, will be generated"
          fi
      
      - name: ðŸ“Š Check documentation structure
        run: |
          echo "ðŸ“ Checking documentation structure..."
          if [ -d "${{ env.DOCS_DIR }}/api" ]; then
            echo "âœ… API directory exists"
          else
            echo "âš ï¸ API directory not found"
          fi
          
          if [ -d "${{ env.DOCS_DIR }}/assets" ]; then
            echo "âœ… Assets directory exists"
          else
            echo "âš ï¸ Assets directory not found"
          fi
          
          if [ -f "${{ env.DOCS_DIR }}/README.md" ]; then
            echo "âœ… README.md exists"
          else
            echo "âš ï¸ README.md not found"
          fi

  # ============================================================================
  # GERAÃ‡ÃƒO DE DOCUMENTAÃ‡ÃƒO
  # ============================================================================
  generate:
    name: ðŸ“š Generate Documentation
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.DOCS_DIR }}/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci
      
      - name: ðŸ”„ Generate API documentation
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸš€ Generating API documentation..."
          npm run docs:generate
          
          # Verificar se a documentaÃ§Ã£o foi gerada
          if [ -f "api/openapi.yaml" ]; then
            echo "âœ… OpenAPI YAML generated"
            wc -l api/openapi.yaml
          else
            echo "âŒ OpenAPI YAML not generated"
            exit 1
          fi
          
          if [ -f "api/openapi.json" ]; then
            echo "âœ… OpenAPI JSON generated"
            wc -l api/openapi.json
          else
            echo "âŒ OpenAPI JSON not generated"
            exit 1
          fi
      
      - name: ðŸ“Š Generate coverage report
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ“Š Generating coverage report..."
          if [ -f "api/coverage-report.md" ]; then
            echo "âœ… Coverage report generated"
            head -20 api/coverage-report.md
          else
            echo "âš ï¸ Coverage report not generated"
          fi
      
      - name: ðŸ“‹ List generated files
        run: |
          echo "ðŸ“ Generated files:"
          find ${{ env.DOCS_DIR }}/api -type f -name "*.yaml" -o -name "*.json" -o -name "*.md" | head -10
      
      - name: ðŸ’¾ Upload generated docs
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: ${{ env.DOCS_DIR }}/api/
          retention-days: 7

  # ============================================================================
  # BUILD E OTIMIZAÃ‡ÃƒO
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build Documentation
    runs-on: ubuntu-latest
    needs: generate
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download generated docs
        uses: actions/download-artifact@v4
        with:
          name: generated-docs
          path: ${{ env.DOCS_DIR }}/api/
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci
      
      - name: ðŸ—ï¸ Build documentation
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ—ï¸ Building documentation..."
          npm run docs:build
          
          # Verificar se o build foi bem-sucedido
          if [ -d "dist" ]; then
            echo "âœ… Documentation built successfully"
            ls -la dist/
          else
            echo "âš ï¸ Build directory not found, using docs directory"
          fi
      
      - name: ðŸ“Š Optimize assets
        run: |
          echo "ðŸ“Š Optimizing assets..."
          
          # Comprimir arquivos grandes
          find ${{ env.DOCS_DIR }}/assets -name "*.js" -exec gzip -k {} \;
          find ${{ env.DOCS_DIR }}/assets -name "*.css" -exec gzip -k {} \;
          
          echo "âœ… Assets optimized"
      
      - name: ðŸ“‹ Generate build report
        run: |
          echo "ðŸ“‹ Generating build report..."
          cat > build-report.md << EOF
          # ðŸ“š Build Report - Documentation
          
          **Build Date:** $(date)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## ðŸ“Š Statistics
          
          - **Total Files:** $(find ${{ env.DOCS_DIR }} -type f | wc -l)
          - **Total Size:** $(du -sh ${{ env.DOCS_DIR }} | cut -f1)
          - **API Endpoints:** $(grep -c "paths:" ${{ env.DOCS_DIR }}/api/openapi.yaml || echo "0")
          
          ## ðŸ“ Generated Files
          
          \`\`\`
          $(find ${{ env.DOCS_DIR }}/api -type f | head -20)
          \`\`\`
          
          ## âœ… Build Status
          
          - [x] OpenAPI specification generated
          - [x] Documentation structure validated
          - [x] Assets optimized
          - [x] Build completed successfully
          
          EOF
          
          echo "âœ… Build report generated"
      
      - name: ðŸ’¾ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: built-docs
          path: ${{ env.DOCS_DIR }}/
          retention-days: 30

  # ============================================================================
  # DEPLOY PARA PRODUÃ‡ÃƒO
  # ============================================================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: built-docs
          path: ${{ env.DOCS_DIR }}/
      
      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.DOCS_DIR }}
          cname: docs.sabrina-costa.com
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸ“š Deploy docs: ${{ github.sha }}'
      
      - name: ðŸ”” Notify deployment
        run: |
          echo "ðŸŽ‰ Documentation deployed to GitHub Pages!"
          echo "ðŸ“– URL: https://docs.sabrina-costa.com"
          echo "ðŸ”— Commit: ${{ github.sha }}"

  # ============================================================================
  # DEPLOY PARA STAGING
  # ============================================================================
  deploy-staging:
    name: ðŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    environment: staging
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: built-docs
          path: ${{ env.DOCS_DIR }}/
      
      - name: ðŸ§ª Deploy to staging
        run: |
          echo "ðŸ§ª Deploying to staging environment..."
          echo "ðŸ“– Staging URL: https://staging-docs.sabrina-costa.com"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          
          # Aqui vocÃª pode adicionar lÃ³gica para deploy em staging
          # Por exemplo, usando Vercel, Netlify, ou outro serviÃ§o
          
          echo "âœ… Staging deployment completed"

  # ============================================================================
  # NOTIFICAÃ‡Ã•ES
  # ============================================================================
  notify:
    name: ðŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()
    
    steps:
      - name: ðŸ“¢ Notify on success
        if: needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success'
        run: |
          echo "ðŸŽ‰ Documentation deployment successful!"
          echo "ðŸ“– Production: https://docs.sabrina-costa.com"
          echo "ðŸ§ª Staging: https://staging-docs.sabrina-costa.com"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
      
      - name: ðŸ“¢ Notify on failure
        if: needs.deploy-production.result == 'failure' || needs.deploy-staging.result == 'failure'
        run: |
          echo "âŒ Documentation deployment failed!"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          echo "ðŸ“‹ Check the logs for more details"
      
      - name: ðŸ“Š Generate deployment summary
        run: |
          cat > deployment-summary.md << EOF
          # ðŸ“š Deployment Summary
          
          **Date:** $(date)
          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.actor }}
          **Branch:** ${{ github.ref_name }}
          **Event:** ${{ github.event_name }}
          
          ## ðŸš€ Deployment Status
          
          - **Production:** ${{ needs.deploy-production.result || 'skipped' }}
          - **Staging:** ${{ needs.deploy-staging.result || 'skipped' }}
          
          ## ðŸ“– URLs
          
          - **Production:** https://docs.sabrina-costa.com
          - **Staging:** https://staging-docs.sabrina-costa.com
          
          ## ðŸ“Š Build Info
          
          - **Node.js:** ${{ env.NODE_VERSION }}
          - **OS:** Ubuntu Latest
          - **Duration:** ${{ github.run_duration }}
          
          EOF
          
          echo "ðŸ“Š Deployment summary generated"
