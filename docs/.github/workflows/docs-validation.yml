name: ðŸ” Validate Documentation

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'backend/**/*.js'
  schedule:
    # Executar validaÃ§Ã£o diariamente Ã s 2h UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  DOCS_DIR: 'docs'

jobs:
  # ============================================================================
  # VALIDAÃ‡ÃƒO DE ESTRUTURA
  # ============================================================================
  validate-structure:
    name: ðŸ“ Validate Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Check documentation structure
        run: |
          echo "ðŸ” Validating documentation structure..."
          
          # Verificar diretÃ³rios obrigatÃ³rios
          required_dirs=(
            "docs/api"
            "docs/assets"
            "docs/scripts"
            "docs/tutorials"
            "docs/how-to-guides"
            "docs/reference"
            "docs/explanation"
            "docs/meta"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir exists"
            else
              echo "âŒ $dir missing"
              exit 1
            fi
          done
          
          # Verificar arquivos obrigatÃ³rios
          required_files=(
            "docs/README.md"
            "docs/package.json"
            "docs/api/openapi.yaml"
            "docs/assets/js/analytics.js"
            "docs/assets/js/docsearch.js"
            "docs/assets/js/feedback-widget.js"
            "docs/assets/js/mermaid-diagrams.js"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          echo "âœ… Documentation structure is valid"

  # ============================================================================
  # VALIDAÃ‡ÃƒO DE CONTEÃšDO
  # ============================================================================
  validate-content:
    name: ðŸ“ Validate Content
    runs-on: ubuntu-latest
    needs: validate-structure
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.DOCS_DIR }}/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci
      
      - name: ðŸ“ Check markdown files
        run: |
          echo "ðŸ“ Validating markdown files..."
          
          # Verificar se todos os arquivos .md tÃªm tÃ­tulo
          find ${{ env.DOCS_DIR }} -name "*.md" -exec sh -c '
            for file; do
              if ! head -1 "$file" | grep -q "^# "; then
                echo "âŒ $file missing title (should start with # )"
                exit 1
              else
                echo "âœ… $file has title"
              fi
            done
          ' _ {} +
          
          # Verificar se nÃ£o hÃ¡ links quebrados
          echo "ðŸ”— Checking for broken links..."
          find ${{ env.DOCS_DIR }} -name "*.md" -exec grep -l "\[.*\](.*)" {} \; | while read file; do
            echo "Checking links in $file"
            # Aqui vocÃª pode adicionar validaÃ§Ã£o de links se necessÃ¡rio
          done
          
          echo "âœ… Markdown files are valid"
      
      - name: ðŸ“Š Check OpenAPI specification
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ“Š Validating OpenAPI specification..."
          
          if [ -f "api/openapi.yaml" ]; then
            # Verificar se o arquivo nÃ£o estÃ¡ vazio
            if [ -s "api/openapi.yaml" ]; then
              echo "âœ… OpenAPI YAML is not empty"
              
              # Verificar se contÃ©m informaÃ§Ãµes bÃ¡sicas
              if grep -q "openapi:" api/openapi.yaml; then
                echo "âœ… OpenAPI version specified"
              else
                echo "âŒ OpenAPI version not found"
                exit 1
              fi
              
              if grep -q "info:" api/openapi.yaml; then
                echo "âœ… API info section found"
              else
                echo "âŒ API info section missing"
                exit 1
              fi
              
              if grep -q "paths:" api/openapi.yaml; then
                echo "âœ… API paths section found"
              else
                echo "âŒ API paths section missing"
                exit 1
              fi
              
            else
              echo "âŒ OpenAPI YAML is empty"
              exit 1
            fi
          else
            echo "âš ï¸ OpenAPI YAML not found, will be generated"
          fi
          
          echo "âœ… OpenAPI specification is valid"
      
      - name: ðŸ” Check JavaScript files
        run: |
          echo "ðŸ” Validating JavaScript files..."
          
          # Verificar se todos os arquivos JS tÃªm sintaxe vÃ¡lida
          find ${{ env.DOCS_DIR }}/assets/js -name "*.js" -exec node -c {} \; 2>/dev/null || {
            echo "âŒ JavaScript syntax error found"
            exit 1
          }
          
          echo "âœ… JavaScript files are valid"
      
      - name: ðŸ“‹ Generate content report
        run: |
          cat > content-validation-report.md << EOF
          # ðŸ“ Content Validation Report
          
          **Date:** $(date)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## ðŸ“Š Statistics
          
          - **Total Markdown Files:** $(find ${{ env.DOCS_DIR }} -name "*.md" | wc -l)
          - **Total JavaScript Files:** $(find ${{ env.DOCS_DIR }}/assets/js -name "*.js" | wc -l)
          - **Total CSS Files:** $(find ${{ env.DOCS_DIR }}/assets -name "*.css" | wc -l)
          - **Total HTML Files:** $(find ${{ env.DOCS_DIR }} -name "*.html" | wc -l)
          
          ## ðŸ“ File Structure
          
          \`\`\`
          $(find ${{ env.DOCS_DIR }} -type f | head -20)
          \`\`\`
          
          ## âœ… Validation Results
          
          - [x] Documentation structure validated
          - [x] Markdown files validated
          - [x] OpenAPI specification validated
          - [x] JavaScript files validated
          
          EOF
          
          echo "ðŸ“‹ Content validation report generated"

  # ============================================================================
  # VALIDAÃ‡ÃƒO DE PERFORMANCE
  # ============================================================================
  validate-performance:
    name: âš¡ Validate Performance
    runs-on: ubuntu-latest
    needs: validate-content
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Check file sizes
        run: |
          echo "ðŸ“Š Checking file sizes..."
          
          # Verificar se nÃ£o hÃ¡ arquivos muito grandes
          find ${{ env.DOCS_DIR }} -type f -size +1M -exec echo "âš ï¸ Large file found: {}" \;
          
          # Verificar tamanho total da documentaÃ§Ã£o
          total_size=$(du -sh ${{ env.DOCS_DIR }} | cut -f1)
          echo "ðŸ“ Total documentation size: $total_size"
          
          # Verificar se o tamanho estÃ¡ dentro do limite (ex: 50MB)
          size_mb=$(du -sm ${{ env.DOCS_DIR }} | cut -f1)
          if [ $size_mb -gt 50 ]; then
            echo "âš ï¸ Documentation size exceeds 50MB"
          else
            echo "âœ… Documentation size is within limits"
          fi
      
      - name: ðŸ–¼ï¸ Check images
        run: |
          echo "ðŸ–¼ï¸ Checking images..."
          
          # Verificar se hÃ¡ imagens muito grandes
          find ${{ env.DOCS_DIR }}/assets -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" | while read img; do
            size=$(stat -c%s "$img")
            if [ $size -gt 1048576 ]; then  # 1MB
              echo "âš ï¸ Large image found: $img ($(($size / 1024 / 1024))MB)"
            else
              echo "âœ… Image size OK: $img"
            fi
          done
      
      - name: ðŸ“¦ Check dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ“¦ Checking dependencies..."
          
          if [ -f "package.json" ]; then
            echo "âœ… package.json exists"
            
            # Verificar se nÃ£o hÃ¡ dependÃªncias desatualizadas
            npm outdated || echo "âš ï¸ Some dependencies are outdated"
          else
            echo "âš ï¸ package.json not found"
          fi
      
      - name: ðŸ“‹ Generate performance report
        run: |
          cat > performance-validation-report.md << EOF
          # âš¡ Performance Validation Report
          
          **Date:** $(date)
          **Commit:** ${{ github.sha }}
          
          ## ðŸ“Š File Sizes
          
          - **Total Size:** $(du -sh ${{ env.DOCS_DIR }} | cut -f1)
          - **Largest Files:** 
            \`\`\`
            $(find ${{ env.DOCS_DIR }} -type f -exec ls -lh {} \; | sort -k5 -hr | head -10)
            \`\`\`
          
          ## ðŸ–¼ï¸ Images
          
          - **Total Images:** $(find ${{ env.DOCS_DIR }}/assets -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" | wc -l)
          - **Image Sizes:** $(find ${{ env.DOCS_DIR }}/assets -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -exec ls -lh {} \; | head -5)
          
          ## ðŸ“¦ Dependencies
          
          - **Total Dependencies:** $(cat ${{ env.DOCS_DIR }}/package.json | grep -c '"' || echo "0")
          - **Outdated Dependencies:** $(npm outdated 2>/dev/null | wc -l || echo "0")
          
          EOF
          
          echo "ðŸ“‹ Performance validation report generated"

  # ============================================================================
  # RELATÃ“RIO FINAL
  # ============================================================================
  generate-report:
    name: ðŸ“‹ Generate Final Report
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-content, validate-performance]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“‹ Generate final validation report
        run: |
          cat > final-validation-report.md << EOF
          # ðŸ” Documentation Validation Report
          
          **Date:** $(date)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Event:** ${{ github.event_name }}
          
          ## ðŸ“Š Validation Results
          
          | Check | Status | Details |
          |-------|--------|---------|
          | Structure | ${{ needs.validate-structure.result }} | Documentation structure validation |
          | Content | ${{ needs.validate-content.result }} | Markdown and OpenAPI validation |
          | Performance | ${{ needs.validate-performance.result }} | File sizes and dependencies |
          
          ## ðŸŽ¯ Summary
          
          - **Overall Status:** ${{ needs.validate-structure.result == 'success' && needs.validate-content.result == 'success' && needs.validate-performance.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}
          - **Total Checks:** 3
          - **Passed:** $(echo "${{ needs.validate-structure.result == 'success' && 1 || 0 }} + ${{ needs.validate-content.result == 'success' && 1 || 0 }} + ${{ needs.validate-performance.result == 'success' && 1 || 0 }}" | bc)
          - **Failed:** $(echo "3 - (${{ needs.validate-structure.result == 'success' && 1 || 0 }} + ${{ needs.validate-content.result == 'success' && 1 || 0 }} + ${{ needs.validate-performance.result == 'success' && 1 || 0 }})" | bc)
          
          ## ðŸ“ Documentation Structure
          
          \`\`\`
          $(find ${{ env.DOCS_DIR }} -type d | head -20)
          \`\`\`
          
          ## ðŸ“ Next Steps
          
          ${{ needs.validate-structure.result == 'success' && '- [x] Structure validation passed' || '- [ ] Fix structure issues' }}
          ${{ needs.validate-content.result == 'success' && '- [x] Content validation passed' || '- [ ] Fix content issues' }}
          ${{ needs.validate-performance.result == 'success' && '- [x] Performance validation passed' || '- [ ] Fix performance issues' }}
          
          EOF
          
          echo "ðŸ“‹ Final validation report generated"
      
      - name: ðŸ“¤ Upload validation reports
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            content-validation-report.md
            performance-validation-report.md
            final-validation-report.md
          retention-days: 30
      
      - name: ðŸ“¢ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('final-validation-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
