<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprova√ß√µes | Dashboard Sabrina Costa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/pt-br.js"></script>
    
    <!-- API Client / Auth -->
    <script src="./assets/js/api.js"></script>
    <script src="./assets/js/auth.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50" x-data="approvalsApp()" x-init="init()">
    
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="./index.html" class="text-2xl font-bold text-pink-600">Dashboard Sabrina</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="./dashboard.html" class="text-gray-600 hover:text-gray-900">Dashboard</a>
                    <a href="./configuracoes-automacao.html" class="text-gray-600 hover:text-gray-900">Automa√ß√µes</a>
                    <a href="./aprovacoes.html" class="text-pink-600 font-medium">Aprova√ß√µes</a>
                    <button @click="logout()" class="text-gray-600 hover:text-gray-900">Sair</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-gradient-to-r from-purple-600 to-pink-600 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">‚úÖ Aprova√ß√µes</h1>
                    <p class="mt-2 text-purple-100">Gerencie a√ß√µes pendentes e hist√≥rico</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2">
                    <div class="text-sm text-purple-100">Pendentes</div>
                    <div class="text-3xl font-bold" x-text="pending.length || 0"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Loading State -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600"></div>
            <p class="mt-4 text-gray-600">Carregando aprova√ß√µes...</p>
        </div>

        <!-- Tabs -->
        <div x-show="!loading" x-cloak class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button 
                        @click="currentTab = 'pending'"
                        class="px-6 py-3 border-b-2 font-medium text-sm transition-colors"
                        :class="currentTab === 'pending' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    >
                        ‚è≥ Pendentes (<span x-text="pending.length"></span>)
                    </button>
                    <button 
                        @click="currentTab = 'history'; loadHistory()"
                        class="px-6 py-3 border-b-2 font-medium text-sm transition-colors"
                        :class="currentTab === 'history' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    >
                        üìã Hist√≥rico (<span x-text="history.length"></span>)
                    </button>
                </nav>
            </div>
        </div>

        <!-- Pending Approvals Tab -->
        <div x-show="!loading && currentTab === 'pending'" x-cloak>
            
            <!-- Empty State -->
            <div x-show="pending.length === 0" class="bg-white rounded-lg shadow p-12 text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhuma aprova√ß√£o pendente!</h3>
                <p class="text-gray-600">Quando houver a√ß√µes aguardando sua decis√£o, elas aparecer√£o aqui.</p>
            </div>

            <!-- Pending List -->
            <div x-show="pending.length > 0" class="space-y-4">
                <template x-for="approval in pending" :key="approval.id">
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                        <div class="p-6">
                            <!-- Header -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <h3 class="text-lg font-semibold text-gray-900" x-text="approval.workflow_name"></h3>
                                        <!-- Priority Badge -->
                                        <span 
                                            class="px-2 py-1 text-xs font-medium rounded-full"
                                            :class="{
                                                'bg-red-100 text-red-800': approval.priority === 'urgent',
                                                'bg-orange-100 text-orange-800': approval.priority === 'high',
                                                'bg-yellow-100 text-yellow-800': approval.priority === 'normal',
                                                'bg-gray-100 text-gray-800': approval.priority === 'low'
                                            }"
                                            x-text="approval.priority === 'urgent' ? 'üî¥ Urgente' : 
                                                    approval.priority === 'high' ? 'üü† Alta' :
                                                    approval.priority === 'normal' ? 'üü° Normal' : 
                                                    '‚ö™ Baixa'">
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">
                                        <span x-text="formatActionType(approval.action_type)"></span> ‚Ä¢ 
                                        <span x-text="formatDate(approval.created_at)"></span>
                                    </p>
                                </div>
                                <!-- Expiration -->
                                <div x-show="approval.expires_at" class="text-right">
                                    <div class="text-xs text-gray-500">Expira em</div>
                                    <div class="text-sm font-medium text-orange-600" x-text="formatDate(approval.expires_at)"></div>
                                </div>
                            </div>

                            <!-- Reason -->
                            <div x-show="approval.reason" class="mb-4">
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm font-medium text-yellow-800">Motivo</p>
                                            <p class="mt-1 text-sm text-yellow-700" x-text="approval.reason"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Impact -->
                            <div x-show="approval.impact" class="mb-4">
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">Impacto esperado:</span>
                                    <span x-text="approval.impact"></span>
                                </div>
                            </div>

                            <!-- Action Data Preview -->
                            <div class="mb-4 bg-gray-50 rounded p-3">
                                <div class="text-xs font-medium text-gray-500 mb-2">DADOS DA A√á√ÉO</div>
                                <pre class="text-xs text-gray-700 overflow-x-auto" x-text="JSON.stringify(approval.action_data, null, 2)"></pre>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center space-x-3">
                                <button 
                                    @click="approve(approval.id)"
                                    :disabled="processing === approval.id"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                                >
                                    <span x-show="processing !== approval.id">
                                        ‚úÖ Aprovar
                                    </span>
                                    <span x-show="processing === approval.id" class="flex items-center">
                                        <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Processando...
                                    </span>
                                </button>
                                <button 
                                    @click="reject(approval.id)"
                                    :disabled="processing === approval.id"
                                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    ‚ùå Rejeitar
                                </button>
                                <button 
                                    @click="showDetails(approval)"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-lg transition-colors"
                                >
                                    üìä Detalhes
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- History Tab -->
        <div x-show="!loading && currentTab === 'history'" x-cloak>
            
            <!-- Loading History -->
            <div x-show="historyLoading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600"></div>
                <p class="mt-4 text-gray-600">Carregando hist√≥rico...</p>
            </div>

            <!-- Empty State -->
            <div x-show="!historyLoading && history.length === 0" class="bg-white rounded-lg shadow p-12 text-center">
                <div class="text-6xl mb-4">üìã</div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhum hist√≥rico ainda</h3>
                <p class="text-gray-600">Quando voc√™ aprovar ou rejeitar a√ß√µes, elas aparecer√£o aqui.</p>
            </div>

            <!-- History List -->
            <div x-show="!historyLoading && history.length > 0" class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Workflow
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    A√ß√£o
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Data
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Decis√£o
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="item in history" :key="item.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="item.workflow_name"></div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-900" x-text="formatActionType(item.action_type)"></div>
                                        <div class="text-xs text-gray-500" x-text="item.reason"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span 
                                            class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                            :class="{
                                                'bg-green-100 text-green-800': item.status === 'approved' || item.status === 'executed',
                                                'bg-red-100 text-red-800': item.status === 'rejected',
                                                'bg-gray-100 text-gray-800': item.status === 'expired'
                                            }"
                                            x-text="item.status === 'approved' ? 'Aprovado' : 
                                                    item.status === 'executed' ? 'Executado' :
                                                    item.status === 'rejected' ? 'Rejeitado' : 
                                                    'Expirado'">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="formatDate(item.approved_at || item.rejected_at || item.created_at)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="item.approved_by_name || '-'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Details Modal -->
    <div x-show="detailsModal" 
         x-cloak
         @click.away="detailsModal = false"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4"
    >
        <div @click.stop class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Detalhes da Aprova√ß√£o</h3>
                <button @click="detailsModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div x-show="selectedApproval" class="px-6 py-4">
                <dl class="space-y-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Workflow</dt>
                        <dd class="mt-1 text-sm text-gray-900" x-text="selectedApproval?.workflow_name"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Tipo de A√ß√£o</dt>
                        <dd class="mt-1 text-sm text-gray-900" x-text="formatActionType(selectedApproval?.action_type)"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Motivo</dt>
                        <dd class="mt-1 text-sm text-gray-900" x-text="selectedApproval?.reason || 'N/A'"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Impacto</dt>
                        <dd class="mt-1 text-sm text-gray-900" x-text="selectedApproval?.impact || 'N/A'"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Dados da A√ß√£o</dt>
                        <dd class="mt-1">
                            <pre class="text-xs bg-gray-50 rounded p-3 overflow-x-auto" x-text="JSON.stringify(selectedApproval?.action_data, null, 2)"></pre>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Criado em</dt>
                        <dd class="mt-1 text-sm text-gray-900" x-text="formatDate(selectedApproval?.created_at, true)"></dd>
                    </div>
                    <div x-show="selectedApproval?.expires_at">
                        <dt class="text-sm font-medium text-gray-500">Expira em</dt>
                        <dd class="mt-1 text-sm text-gray-900" x-text="formatDate(selectedApproval?.expires_at, true)"></dd>
                    </div>
                </dl>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                <button @click="detailsModal = false" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Alpine.js Component -->
    <script>
        function approvalsApp() {
            return {
                loading: true,
                currentTab: 'pending',
                pending: [],
                history: [],
                historyLoading: false,
                processing: null,
                detailsModal: false,
                selectedApproval: null,

                async init() {
                    dayjs.extend(dayjs_plugin_relativeTime);
                    dayjs.locale('pt-br');
                    
                    await this.loadPending();
                    
                    // Auto-refresh every 30 seconds
                    setInterval(() => {
                        if (this.currentTab === 'pending') {
                            this.loadPending();
                        }
                    }, 30000);
                },

                async loadPending() {
                    try {
                        this.loading = true;
                        const response = await API.get('/automations/pending-approvals/list');
                        
                        if (response.success) {
                            this.pending = response.pending;
                        } else {
                            throw new Error(response.error || 'Erro ao carregar pendentes');
                        }
                    } catch (err) {
                        console.error('Error loading pending:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadHistory() {
                    try {
                        this.historyLoading = true;
                        const response = await API.get('/automations/approvals/history?limit=50');
                        
                        if (response.success) {
                            this.history = response.history;
                        }
                    } catch (err) {
                        console.error('Error loading history:', err);
                    } finally {
                        this.historyLoading = false;
                    }
                },

                async approve(id) {
                    if (!confirm('Voc√™ tem certeza que deseja APROVAR esta a√ß√£o?\n\nEla ser√° executada pelo sistema.')) {
                        return;
                    }

                    try {
                        this.processing = id;
                        const response = await API.post(`/automations/approve/${id}`);

                        if (response.success) {
                            this.showToast('‚úÖ A√ß√£o aprovada com sucesso!', 'success');
                            await this.loadPending();
                        } else {
                            throw new Error(response.error);
                        }
                    } catch (err) {
                        console.error('Error approving:', err);
                        alert('Erro ao aprovar: ' + err.message);
                    } finally {
                        this.processing = null;
                    }
                },

                async reject(id) {
                    const reason = prompt('Motivo da rejei√ß√£o (opcional):');
                    if (reason === null) return; // Cancelled

                    try {
                        this.processing = id;
                        const response = await API.post(`/automations/reject/${id}`, {
                            reason: reason || 'Sem motivo informado'
                        });

                        if (response.success) {
                            this.showToast('‚ùå A√ß√£o rejeitada', 'warning');
                            await this.loadPending();
                        } else {
                            throw new Error(response.error);
                        }
                    } catch (err) {
                        console.error('Error rejecting:', err);
                        alert('Erro ao rejeitar: ' + err.message);
                    } finally {
                        this.processing = null;
                    }
                },

                showDetails(approval) {
                    this.selectedApproval = approval;
                    this.detailsModal = true;
                },

                formatActionType(type) {
                    const types = {
                        'pause_campaign': 'Pausar Campanha',
                        'post_content': 'Postar Conte√∫do',
                        'send_message': 'Enviar Mensagem',
                        'update_budget': 'Atualizar Budget',
                        'suggest_pause_campaign': 'Sugerir Pausar Campanha'
                    };
                    return types[type] || type;
                },

                formatDate(dateString, full = false) {
                    if (!dateString) return 'N/A';
                    if (full) {
                        return dayjs(dateString).format('DD/MM/YYYY HH:mm:ss');
                    }
                    return dayjs(dateString).fromNow();
                },

                showToast(message, type = 'success') {
                    const colors = {
                        success: 'bg-green-500',
                        warning: 'bg-yellow-500',
                        error: 'bg-red-500'
                    };
                    
                    const toast = document.createElement('div');
                    toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                },

                logout() {
                    Auth.logout();
                }
            }
        }
    </script>

</body>
</html>

